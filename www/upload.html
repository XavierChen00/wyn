<!DOCTYPE html>
<html>
	<head>
			<link href='http://fonts.googleapis.com/css?family=Josefin+Sans:400,700' rel='stylesheet' type='text/css'>
			<link rel="stylesheet" type="text/css" href="css/stylesheet.css">
			<!-- Latest compiled and minified CSS -->
			<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

			<!-- Optional theme -->
			<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

			<!-- Latest compiled and minified JavaScript -->
			<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
			<script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
			<script src="https://www.parsecdn.com/js/parse-1.5.0.min.js"></script>
			<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
		<!--  <script type="text/javascript" charset="utf-8" src="js/upload.js"></script> -->
			<script type="text/javascript" charset="utf-8">

			Parse.initialize("hrA3EdYBYrNz9SKLtUG0OpSIN5L9L0zQUvDIyLUs", "ALVDecc9XnfGQuCCO3rARwFxIOFSuRjyPkMuOHAp");

			var NoteOb = Parse.Object.extend("Upload");

			$(document).on("pageshow", "#home", function(e, ui) {
				$.mobile.loading("show");

				var query = new Parse.Query(NoteOb);
				query.limit(10);
				query.descending("createdAt");

				query.find({
					success:function(results) {
						$.mobile.loading("hide");
						var s = "";
						for(var i=0; i<results.length; i++) {
							//Lame - should be using a template
							s += "<p>";
							s += "<h3>Note " + results[i].createdAt + "</h3>";
							s += results[i].get("text");
							var pic = results[i].get("picture");
							if(pic) {
								s += "<br/><img src='" + pic.url() + "'>";
							}
							s += "</p>";
						}
						$("#home div[data-role=content]").html(s);
					},error:function(e) {
						$.mobile.loading("hide");

					}
				});
			});

			$(document).on("pageshow", "#addNote", function(e, ui) {

				var imagedata = "";

				$("#saveNoteBtn").on("touchend", function(e) {
					e.preventDefault();
					$(this).attr("disabled","disabled").button("refresh");

					var noteText = $("#noteText").val();
					if(noteText === '') return;

					/*
					A bit complex - we have to handle an optional pic save
					*/
					if(imagedata !== "") {
						var parseFile = new Parse.File("pic.jpg", {base64:imagedata});
						console.log(parseFile);
							parseFile.save().then(function() {
								var note = new NoteOb();
								note.set("Username", Parse.User.current().getUsername());
								note.set("Question",noteText);
								note.set("Photo",parseFile);
								note.save(null, {
									success:function(ob) {
										$.mobile.changePage("#home");
									}, error:function(e) {
										console.log("Oh crap", e);
									}
								});
								cleanUp();
							}, function(error) {
								console.log("Error");
								console.log(error);
							});

          }
        });

				$("#takePicBtn").on("click", function(e) {
					e.preventDefault();
					navigator.camera.getPicture(gotPic, failHandler,
						{quality:50, destinationType:navigator.camera.DestinationType.DATA_URL,
						 sourceType:navigator.camera.PictureSourceType.PHOTOLIBRARY});
				});

				function gotPic(data) {
					console.log('got here');
					imagedata = data;
					$("#takePicBtn").text("Picture Taken!").button("refresh");
				}

				function failHandler(e) {
					alert("ErrorFromC");
					alert(e);
					console.log(e.toString());
				}

				function cleanUp() {
					imagedata = "";
					$("#saveNoteBtn").removeAttr("disabled").button("refresh");
					$("#noteText").val("");
					$("#takePicBtn").text("Add Pic").button("refresh");
				}

			});

</script>

			<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

	</head>
	<body class = "upload">
		 <div class="WYN"><h1>WYN</h1></div>
		 <p>&nbsp</p>
		 <p>&nbsp</p>
		 <p>&nbsp</p>

<center>
<p> <input type="text" class="form-control" id="noteText" placeholder="What is your Question?"> </p>
<p>
<button id="takePicBtn">From Photo Library</button></p>
<p> <button id="saveNoteBtn">Post Your Question!</button></p>
<img style="display:none;width:60px;height:60px;" id="smallImage" src="" />
    <img style="display:none;" id="largeImage" src="" />
</center>


		<footer class="site-footer">
		<a href="homepage.html"><span class="glyphicon glyphicon-home" aria-hidden="true"></span></a>
		<a href="upload.html"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a>
		<a href = "profile.html"><span class="glyphicon glyphicon-user" aria-hidden="true"></span></a>
		</footer>
	</body>
</html>
